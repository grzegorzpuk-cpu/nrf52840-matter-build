name: Build Matter Example (nRF52840)

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'NCS SDK Version'
        required: true
        default: 'v3.1.1'
      sample:
        description: 'Sample to build'
        required: true
        default: 'samples/matter/light_bulb'
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/nrfconnect/sdk-nrf-toolchain:${{ github.event.inputs.sdk_version || 'v3.1.1' }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: project

      - name: Cache SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: sdk
          key: nrf-sdk-${{ github.event.inputs.sdk_version || 'v3.1.1' }}

      - name: Initialize West
        run: |
          python3 -m pip install west
          if [ ! -d "sdk/.west" ]; then
            west init -m https://github.com/nrfconnect/sdk-nrf --mr ${{ github.event.inputs.sdk_version || 'v3.1.1' }} sdk
          fi
          cd sdk
          west update --narrow -o=--depth=1
          west zephyr-export

      - name: Export Source Code to Repo
        id: export-code
        run: |
          # Jeśli kod jeszcze nie istnieje w repozytorium, skopiuj go z SDK nRF
          if [ ! -d "project/samples" ]; then
            mkdir -p project/samples
            cp -r sdk/nrf/samples/matter/light_bulb project/samples/
            echo "exported=true" >> $GITHUB_OUTPUT
          else
            echo "exported=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Exported Code
        if: steps.export-code.outputs.exported == 'true'
        run: |
          cd project
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add samples/
          git commit -m "Bootstrap: Exported light_bulb sample from SDK"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Matter Sample (Local Source)
        working-directory: sdk
        run: |
          # Budujemy z lokalnego źródła wewnątrz repozytorium
          west build -b nrf52840dk/nrf52840 ../project/samples/light_bulb

      - name: Collect Artifacts
        if: success()
        run: |
          mkdir -p artifacts
          # Szukamy merged.hex (finalny obraz z bootloaderem) oraz zephyr.hex/bin/elf
          find sdk/build -name "merged.hex" -exec cp {} artifacts/matter_full.hex \;
          find sdk/build -name "zephyr.hex" -exec cp {} artifacts/matter_app.hex \;
          find sdk/build -name "zephyr.bin" -exec cp {} artifacts/matter_app.bin \;
          find sdk/build -name "zephyr.elf" -exec cp {} artifacts/matter_app.elf \;
          # Dodatkowo kopiujemy matter.ota jeśli istnieje
          find sdk/build -name "*.ota" -exec cp {} artifacts/ \; || true
          ls -R artifacts

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: matter-nrf52840-build
          path: artifacts/
