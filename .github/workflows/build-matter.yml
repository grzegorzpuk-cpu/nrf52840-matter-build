name: Build Matter Example (nRF52840)

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'NCS SDK Version'
        required: true
        default: 'v3.1.1'
      sample:
        description: 'Sample to build'
        required: true
        default: 'samples/matter/light_bulb'
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/nrfconnect/sdk-nrf-toolchain:${{ github.event.inputs.sdk_version || 'v3.1.1' }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: project

      - name: Cache SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: sdk
          key: nrf-sdk-${{ github.event.inputs.sdk_version || 'v3.1.1' }}

      - name: Initialize West
        run: |
          python3 -m pip install west
          if [ ! -d "sdk/.west" ]; then
            west init -m https://github.com/nrfconnect/sdk-nrf --mr ${{ github.event.inputs.sdk_version || 'v3.1.1' }} sdk
          fi
          cd sdk
          west update --narrow -o=--depth=1
          west zephyr-export

      - name: Build Matter Sample
        working-directory: sdk
        run: |
          west build -b nrf52840dk/nrf52840 nrf/${{ github.event.inputs.sample || 'samples/matter/light_bulb' }}

      - name: Collect Artifacts
        if: success()
        run: |
          mkdir -p artifacts
          # Szukamy merged.hex (finalny obraz z bootloaderem) oraz zephyr.hex/bin/elf
          find sdk/build -name "merged.hex" -exec cp {} artifacts/matter_full.hex \;
          find sdk/build -name "zephyr.hex" -exec cp {} artifacts/matter_app.hex \;
          find sdk/build -name "zephyr.bin" -exec cp {} artifacts/matter_app.bin \;
          find sdk/build -name "zephyr.elf" -exec cp {} artifacts/matter_app.elf \;
          # Dodatkowo kopiujemy matter.ota je≈õli istnieje
          find sdk/build -name "*.ota" -exec cp {} artifacts/ \; || true
          ls -R artifacts

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: matter-nrf52840-build
          path: artifacts/
