name: Build Matter Example (nRF52840)

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'NCS SDK Version'
        required: true
        default: 'v2.9.0'
      sample:
        description: 'Sample to build'
        required: true
        default: 'samples/matter/light_bulb'
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: nordicsemi/nrfconnect-sdk:${{ github.event.inputs.sdk_version || 'v2.9.0' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: project

      - name: Initialize West
        run: |
          mkdir sdk
          cd sdk
          west init -m https://github.com/nrfconnect/sdk-nrf --mr ${{ github.event.inputs.sdk_version || 'v2.9.0' }}
          west update --narrow -o=--depth=1
          west zephyr-export

      - name: Build Matter Sample
        working-directory: sdk
        run: |
          west build -b nrf52840dk_nrf52840 nrf/${{ github.event.inputs.sample || 'samples/matter/light_bulb' }}

      - name: Collect Artifacts
        if: success()
        run: |
          mkdir -p artifacts
          find sdk/build/zephyr -name "zephyr.hex" -exec cp {} artifacts/matter_light_bulb.hex \;
          find sdk/build/zephyr -name "zephyr.bin" -exec cp {} artifacts/matter_light_bulb.bin \;
          find sdk/build/zephyr -name "zephyr.elf" -exec cp {} artifacts/matter_light_bulb.elf \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: matter-nrf52840-build
          path: artifacts/
