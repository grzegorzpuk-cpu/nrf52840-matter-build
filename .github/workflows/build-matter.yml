name: Build Matter Example (nRF52840)

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'NCS SDK Version'
        required: true
        default: 'v3.1.1'
      sample:
        description: 'Sample to build'
        required: true
        default: 'samples/matter/light_bulb'
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/nrfconnect/sdk-nrf-toolchain:${{ github.event.inputs.sdk_version || 'v3.1.1' }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: project
          fetch-depth: 0

      - name: Cache SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: sdk
          key: nrf-sdk-${{ github.event.inputs.sdk_version || 'v3.1.1' }}

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-matter-${{ github.event.inputs.sdk_version || 'v3.1.1' }}-${{ github.run_id }}
          restore-keys: |
            ccache-matter-${{ github.event.inputs.sdk_version || 'v3.1.1' }}-

      - name: Cache Build
        uses: actions/cache@v4
        with:
          path: sdk/build
          key: build-matter-${{ github.event.inputs.sdk_version || 'v3.1.1' }}-${{ github.run_id }}
          restore-keys: |
            build-matter-${{ github.event.inputs.sdk_version || 'v3.1.1' }}-

      - name: Initialize West
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache
        run: |
          python3 -m pip install west
          echo "=== Sprawdzanie rozmiaru przed operacjami ==="
          du -sh sdk 2>/dev/null || echo "sdk directory missing"
          
          if [ ! -d "sdk/.west" ]; then
            echo "Cache miss: initializing SDK from scratch..."
            mkdir -p sdk
            cd sdk
            west init -m https://github.com/nrfconnect/sdk-nrf --mr ${{ github.event.inputs.sdk_version || 'v3.1.1' }}
            west update --narrow -o=--depth=1
          else
            echo "Cache hit: checking for updates (fast)..."
            cd sdk
            # Próbujemy najpierw bez pobierania (tylko lokalnie)
            west update --narrow -o=--depth=1 --no-fetch || {
              echo "Local update failed, fetching missing data..."
              west update --narrow -o=--depth=1
            }
          fi
          
          west zephyr-export
          echo "=== Rozmiar SDK po operacjach ==="
          du -sh .

      - name: Export Source Code to Repo
        id: export-code
        run: |
          # Jeśli kod jeszcze nie istnieje w repozytorium (w folderze project), skopiuj go z SDK nRF
          if [ ! -d "project/samples" ]; then
            echo "Exporting samples from SDK..."
            mkdir -p project/samples
            cp -r sdk/nrf/samples/matter/light_bulb project/samples/
          fi
          
          cd project
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add samples/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "exported=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Bootstrap: Exported light_bulb sample from SDK"
            echo "exported=true" >> $GITHUB_OUTPUT
          fi

      - name: Push Exported Code
        if: steps.export-code.outputs.exported == 'true'
        run: |
          cd project
          git pull --rebase origin main
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Matter Sample (Local Source)
        working-directory: sdk
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache
        run: |
          # Ustawienie ccache dla CMake wewnątrz Zephyr
          export CMAKE_C_COMPILER_LAUNCHER=ccache
          export CMAKE_CXX_COMPILER_LAUNCHER=ccache
          
          # Ustawienia ccache
          ccache -M 500M
          ccache -s
          
          # Budujemy przyrostowo (bez -p always)
          # Jeśli katalog build został przywrócony z cache, west build skompiluje tylko zmiany.
          west build -b nrf52840dk/nrf52840 ../project/samples/light_bulb
          
          ccache -s

      - name: Collect Artifacts
        if: success()
        run: |
          mkdir -p artifacts
          # Szukamy merged.hex (finalny obraz z bootloaderem) oraz zephyr.hex/bin/elf
          find sdk/build -name "merged.hex" -exec cp {} artifacts/matter_full.hex \;
          find sdk/build -name "zephyr.hex" -exec cp {} artifacts/matter_app.hex \;
          find sdk/build -name "zephyr.bin" -exec cp {} artifacts/matter_app.bin \;
          find sdk/build -name "zephyr.elf" -exec cp {} artifacts/matter_app.elf \;
          # Dodatkowo kopiujemy matter.ota jeśli istnieje
          find sdk/build -name "*.ota" -exec cp {} artifacts/ \; || true
          ls -R artifacts

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: matter-nrf52840-build
          path: artifacts/
